@page "/client-card/{AccountId:int}"
@rendermode InteractiveServer
@inject ICompanySearchService companySearchService
@inject IDbService dbService

@using ClearKilovat.Interfaces
@using ClearKilovat.Models.Entity
@using Microsoft.EntityFrameworkCore
@using Radzen
@using Radzen.Blazor
@using ClearKilovat.DB
@using ClearKilovat.Models.Parser

@inject PostgreDBContext DbContext

<!-- Add Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<RadzenStack Orientation="Orientation.Vertical" Style="width:100%; max-width:900px; margin:0 auto; padding:20px;">
    <RadzenCard Style="width:100%; padding:30px; border-radius:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: linear-gradient(145deg, #ffffff, #f8f9fa);">
        <div class="card-header" style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
            <i class="fas fa-user-circle fa-2x" style="color:#2ecc71;"></i>
            <h3 style="color:#2ecc71; font-size:28px; margin:0; font-weight:600;">Карточка абонента</h3>
        </div>
        <div style="height:3px; background:linear-gradient(to right, #2ecc71, #27ae60); width:100%; max-width:500px; margin:0 auto 25px; border-radius:2px;"></div>

        <RadzenStack Orientation="Orientation.Vertical" Gap="15px">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                <i class="fas fa-id-card fa-lg" style="color:#34495e;"></i>
                <RadzenLabel Text="Account ID:" Style="font-size:18px; font-weight:500; color:#34495e;" />
                <RadzenLabel Text=@(account.Id.ToString()) Style="font-size:18px; color:#2c3e50;" />
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                <i class="fas fa-home fa-lg" style="color:#34495e;"></i>
                <RadzenLabel Text="Адрес:" Style="font-size:18px; font-weight:500; color:#34495e;" />
                <RadzenLabel Text=@(account.Address) Style="font-size:18px; color:#2c3e50;" />
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                <i class="fas fa-city fa-lg" style="color:#34495e;"></i>
                <RadzenLabel Text="Тип здания:" Style="font-size:18px; font-weight:500; color:#34495e;" />
                <RadzenLabel Text=@(account.BuildingType ?? "—") Style="font-size:18px; color:#2c3e50;" />
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                <i class="fas fa-door-open fa-lg" style="color:#34495e;"></i>
                <RadzenLabel Text="Кол-во комнат:" Style="font-size:18px; font-weight:500; color:#34495e;" />
                <RadzenLabel Text=@(account.RoomsCount?.ToString() ?? "—") Style="font-size:18px; color:#2c3e50;" />
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                <i class="fas fa-users fa-lg" style="color:#34495e;"></i>
                <RadzenLabel Text="Кол-во жильцов:" Style="font-size:18px; font-weight:500; color:#34495e;" />
                <RadzenLabel Text=@(account.ResidentsCount?.ToString() ?? "—") Style="font-size:18px; color:#2c3e50;" />
            </RadzenStack>
            <div class="mt-2" style="height:3px; background:linear-gradient(to right, #2ecc71, #27ae60); width:100%; max-width:500px; margin:0 auto 25px; border-radius:2px;"></div>
            <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                    <i class="fas fa-building fa-lg" style="color:#34495e;"></i>
                    <RadzenLabel Text="Тип объекта с 2gis:" Style="font-size:18px; font-weight:500; color:#34495e;" />
                    <RadzenBadge BadgeStyle="@(isPurposeCommercial ? BadgeStyle.Danger : BadgeStyle.Info)">@(isPurposeCommercial ? "Коммерческий" : "Жилой")</RadzenBadge>
                </RadzenStack>
                @if (isPurposeCommercial && companies.Any())
                {
                    <RadzenStack Orientation="Orientation.Vertical" Gap="5px" Style="margin-left: 30px;">
                        <RadzenLabel Text="Компании в здании:" Style="font-size:16px; font-weight:600; color:#34495e; text-transform: uppercase; margin-top: 10px;" />
                        @foreach (var company in companies)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px" Style="padding: 5px 0;">
                                <i class="fas fa-circle fa-xs" style="color:#2ecc71;"></i>
                                <RadzenLabel Text="@company.Name" Style="font-size:16px; color:#2c3e50; font-weight: 400; text-transform: uppercase;" />
                            </RadzenStack>
                        }
                    </RadzenStack>
                }
            </RadzenStack>

            <RadzenButton Style="width:60px; height:60px; border-radius:50%; background:linear-gradient(145deg, #2ecc71, #27ae60);
                border:none; margin:20px auto 0; display:flex; align-items:center; justify-content:center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.3s;">
                <i class="fas fa-download fa-2x" style="color:white;"></i>
            </RadzenButton>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    [Parameter]
    public int AccountId { get; set; }

    RadzenDataGrid<Consumption> myGrid;

    Account account = new();

    private IdPurposeDTO resultGettingInfo = new();

    private List<ParserAnalytics> parserAnalytics;
    private List<Company> companies = new();
    private List<Company> allCompanies = new();

    private bool isPurposeCommercial = false;

    protected override async Task OnInitializedAsync()
    {
        account = await DbContext.Accounts
            .Include(a => a.Consumptions)
            .FirstOrDefaultAsync(a => a.Id == AccountId)
            ?? new Account();

        allCompanies = dbService.GetCompanies();
        parserAnalytics = dbService.GetParserAnalytics();

        if (!parserAnalytics.Any(x => x.AccountId == account.Id))
        {
            ParserAnalytics newAnalytic = new()
                {
                    AccountId = account.Id
                };

            resultGettingInfo = await companySearchService.GetBuildingId(account.Address);

            string purposeName = resultGettingInfo.PurposeName;
            isPurposeCommercial = companySearchService.IsCommercialBuilding(purposeName);

            newAnalytic.DescriptionReason = purposeName;
            newAnalytic.IsViolator = isPurposeCommercial;

            await dbService.AddAnalyticToDb(newAnalytic);

            if (!string.IsNullOrEmpty(purposeName) && isPurposeCommercial)
            {
                string buildingId = resultGettingInfo.Id;
                companies = await companySearchService.GetCompaniesInBuilding(buildingId);
                foreach (var company in companies)
                {
                    company.AccountId = account.Id;
                }
                await dbService.InsertCompanies(companies);
            }
        }
        else
        {
            companies = allCompanies.Where(x => x.AccountId == account.Id).ToList();
            isPurposeCommercial = parserAnalytics.FirstOrDefault(x => x.AccountId == account.Id).IsViolator;
        }
    }
}
<style>
    .rz-button-md .rzi {
        font-size: 24px !important;
        height: 24px !important;
        line-height: 24px !important;
        width: 24px !important;
    }

    @@media (max-width: 768px) {
        .rz-card {
            padding: 20px;
        }

        h3 {
            font-size: 24px !important;
        }

        .rz-label {
            font-size: 16px !important;
        }
    }
</style>